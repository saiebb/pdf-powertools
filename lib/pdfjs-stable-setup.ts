// Ø¥Ø¹Ø¯Ø§Ø¯ PDF.js Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥ØµØ¯Ø§Ø± Ù…Ø³ØªÙ‚Ø± ÙˆÙ…Ø¬Ø±Ø¨
declare global {
  interface Window {
    pdfjsLib: any;
  }
}

// Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥ØµØ¯Ø§Ø± Ù…Ø³ØªÙ‚Ø± Ù…Ù† PDF.js (2.16.105) - Ø¥ØµØ¯Ø§Ø± Ù‚Ø¯ÙŠÙ… ÙˆÙ…Ø³ØªÙ‚Ø±
const STABLE_PDF_JS_URL = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js';
const STABLE_PDF_WORKER_URL = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

export const setupStablePdfJs = async (): Promise<boolean> => {
  console.log('ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ PDF.js Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥ØµØ¯Ø§Ø± Ù…Ø³ØªÙ‚Ø± (2.16.105)...');
  
  try {
    // Ø¥Ø²Ø§Ù„Ø© PDF.js Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯
    if (typeof window.pdfjsLib !== 'undefined') {
      console.log('ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© PDF.js Ø§Ù„Ø­Ø§Ù„ÙŠ...');
      delete (window as any).pdfjsLib;
    }
    
    // Ø¥Ø²Ø§Ù„Ø© scripts Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    const existingScripts = document.querySelectorAll('script[src*="pdf"]');
    existingScripts.forEach(script => {
      console.log('ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© script:', script.getAttribute('src'));
      script.remove();
    });
    
    // Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙ†Ø¸ÙŠÙ
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø±
    console.log('ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF.js Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø±...');
    await loadScript(STABLE_PDF_JS_URL);
    
    // Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    if (typeof window.pdfjsLib === 'undefined') {
      throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ PDF.js Ø§Ù„Ù…Ø³ØªÙ‚Ø±');
    }
    
    // ØªØ¹ÙŠÙŠÙ† worker
    console.log('âš™ï¸ ØªØ¹ÙŠÙŠÙ† worker Ù„Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø±...');
    window.pdfjsLib.GlobalWorkerOptions.workerSrc = STABLE_PDF_WORKER_URL;
    
    // Ø§Ø®ØªØ¨Ø§Ø± PDF.js
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± PDF.js Ø§Ù„Ù…Ø³ØªÙ‚Ø±...');
    const testResult = await testPdfJs();
    
    if (testResult) {
      console.log('âœ… Ù†Ø¬Ø­ Ø¥Ø¹Ø¯Ø§Ø¯ PDF.js Ø§Ù„Ù…Ø³ØªÙ‚Ø±!');
      console.log('ğŸ“¦ Ø§Ù„Ø¥ØµØ¯Ø§Ø±:', window.pdfjsLib.version);
      console.log('ğŸ”— Worker:', window.pdfjsLib.GlobalWorkerOptions.workerSrc);
      return true;
    } else {
      throw new Error('ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± PDF.js Ø§Ù„Ù…Ø³ØªÙ‚Ø±');
    }
    
  } catch (error: any) {
    console.error('âŒ ÙØ´Ù„ Ø¥Ø¹Ø¯Ø§Ø¯ PDF.js Ø§Ù„Ù…Ø³ØªÙ‚Ø±:', error);
    return false;
  }
};

// ØªØ­Ù…ÙŠÙ„ script
const loadScript = (src: string): Promise<void> => {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = () => {
      console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„:', src);
      resolve();
    };
    script.onerror = (error) => {
      console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„:', src, error);
      reject(new Error(`Failed to load: ${src}`));
    };
    document.head.appendChild(script);
  });
};

// Ø§Ø®ØªØ¨Ø§Ø± PDF.js
const testPdfJs = async (): Promise<boolean> => {
  try {
    if (typeof window.pdfjsLib === 'undefined') {
      return false;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ PDF Ø¨Ø³ÙŠØ· Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    const testPdf = new Uint8Array([
      0x25, 0x50, 0x44, 0x46, 0x2d, 0x31, 0x2e, 0x34, 0x0a,
      0x25, 0xc4, 0xe5, 0xf2, 0xe5, 0xeb, 0xa7, 0xf3, 0xa0, 0xd0, 0xc4, 0xc6, 0x0a,
      0x31, 0x20, 0x30, 0x20, 0x6f, 0x62, 0x6a, 0x0a, 0x3c, 0x3c, 0x2f, 0x54, 0x79, 0x70, 0x65, 0x2f, 0x43, 0x61, 0x74, 0x61, 0x6c, 0x6f, 0x67, 0x2f, 0x50, 0x61, 0x67, 0x65, 0x73, 0x20, 0x32, 0x20, 0x30, 0x20, 0x52, 0x3e, 0x3e, 0x0a, 0x65, 0x6e, 0x64, 0x6f, 0x62, 0x6a, 0x0a,
      0x32, 0x20, 0x30, 0x20, 0x6f, 0x62, 0x6a, 0x0a, 0x3c, 0x3c, 0x2f, 0x54, 0x79, 0x70, 0x65, 0x2f, 0x50, 0x61, 0x67, 0x65, 0x73, 0x2f, 0x4b, 0x69, 0x64, 0x73, 0x5b, 0x33, 0x20, 0x30, 0x20, 0x52, 0x5d, 0x2f, 0x43, 0x6f, 0x75, 0x6e, 0x74, 0x20, 0x31, 0x3e, 0x3e, 0x0a, 0x65, 0x6e, 0x64, 0x6f, 0x62, 0x6a, 0x0a,
      0x33, 0x20, 0x30, 0x20, 0x6f, 0x62, 0x6a, 0x0a, 0x3c, 0x3c, 0x2f, 0x54, 0x79, 0x70, 0x65, 0x2f, 0x50, 0x61, 0x67, 0x65, 0x2f, 0x50, 0x61, 0x72, 0x65, 0x6e, 0x74, 0x20, 0x32, 0x20, 0x30, 0x20, 0x52, 0x2f, 0x4d, 0x65, 0x64, 0x69, 0x61, 0x42, 0x6f, 0x78, 0x5b, 0x30, 0x20, 0x30, 0x20, 0x36, 0x31, 0x32, 0x20, 0x37, 0x39, 0x32, 0x5d, 0x3e, 0x3e, 0x0a, 0x65, 0x6e, 0x64, 0x6f, 0x62, 0x6a, 0x0a,
      0x78, 0x72, 0x65, 0x66, 0x0a, 0x30, 0x20, 0x34, 0x0a, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x36, 0x35, 0x35, 0x33, 0x35, 0x20, 0x66, 0x20, 0x0a, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x39, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6e, 0x20, 0x0a, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x37, 0x34, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6e, 0x20, 0x0a, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x31, 0x32, 0x30, 0x20, 0x30, 0x30, 0x30, 0x30, 0x30, 0x20, 0x6e, 0x20, 0x0a, 0x74, 0x72, 0x61, 0x69, 0x6c, 0x65, 0x72, 0x0a, 0x3c, 0x3c, 0x2f, 0x53, 0x69, 0x7a, 0x65, 0x20, 0x34, 0x2f, 0x52, 0x6f, 0x6f, 0x74, 0x20, 0x31, 0x20, 0x30, 0x20, 0x52, 0x3e, 0x3e, 0x0a, 0x73, 0x74, 0x61, 0x72, 0x74, 0x78, 0x72, 0x65, 0x66, 0x0a, 0x32, 0x31, 0x39, 0x0a, 0x25, 0x25, 0x45, 0x4f, 0x46
    ]);
    
    const loadingTask = window.pdfjsLib.getDocument({ 
      data: testPdf,
      verbosity: 0 
    });
    
    const doc = await loadingTask.promise;
    await doc.destroy();
    
    console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± PDF.js Ø§Ù„Ù…Ø³ØªÙ‚Ø± Ù†Ø¬Ø­');
    return true;
    
  } catch (error: any) {
    console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± PDF.js Ø§Ù„Ù…Ø³ØªÙ‚Ø±:', error);
    return false;
  }
};